import { withAuth } from "next-auth/middleware"

export default withAuth(
  function middleware(req) {
    // Middleware adicional si es necesario
  },
  {
    callbacks: {
      authorized: ({ token, req }) => {
        // Verificar si el usuario está autenticado
        if (!token) return false
        
        // Verificar roles para rutas específicas
        const { pathname } = req.nextUrl
        const userRole = token.role as string
        
        // Rutas que requieren rol ADMIN
        if (pathname.startsWith('/configuracion')) {
          return userRole === 'ADMIN'
        }
        
        // Rutas que requieren ADMIN o VENDEDOR
        if (pathname.startsWith('/pos') || pathname.startsWith('/clientes')) {
          return ['ADMIN', 'VENDEDOR'].includes(userRole)
        }
        
        // Rutas que requieren ADMIN, VENDEDOR o ALMACEN
        if (pathname.startsWith('/inventario')) {
          return ['ADMIN', 'VENDEDOR', 'ALMACEN'].includes(userRole)
        }
        
        return true
      },
    },
  }
)

export const config = {
  matcher: [
    '/dashboard/:path*',
    '/pos/:path*',
    '/inventario/:path*',
    '/clientes/:path*',
    '/reportes/:path*',
    '/facturas/:path*',
    '/configuracion/:path*'
  ]
}
